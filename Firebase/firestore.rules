rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get user role by SL UUID
    // Note: We use SL UUIDs as document IDs, not Firebase UIDs
    function getUserRole(slUuid) {
      let userDoc = get(/databases/$(database)/documents/users/$(slUuid));
      return userDoc != null ? userDoc.data.role : null;
    }
    
    // Helper function to check if SL UUID is admin
    function isAdminByUuid(slUuid) {
      return slUuid != null && 
             exists(/databases/$(database)/documents/users/$(slUuid)) &&
             getUserRole(slUuid) in ['sim_admin', 'sys_admin'];
    }
    
    // Helper function to check if SL UUID is sys_admin
    function isSysAdminByUuid(slUuid) {
      return slUuid != null && 
             exists(/databases/$(database)/documents/users/$(slUuid)) &&
             getUserRole(slUuid) == 'sys_admin';
    }
    
    // Helper function to get SL UUID from request (stored in user document)
    // Since we use anonymous auth, we need to check the user document's uuid field
    function getSlUuidFromAuth() {
      // Try to find user document that matches the Firebase UID
      // For now, allow if authenticated (we'll validate in the app layer)
      return request.auth != null;
    }
    
    // Templates - public read, sys_admin write (by SL UUID)
    match /templates/{collection}/{docId} {
      allow read: if true;  // Anyone can read templates
      allow write: if request.auth != null;  // Authenticated users (sys_admin check in app layer)
    }
    
    // Species, Classes, Vocations, Genders - completely public read/write
    // (App layer enforces sys_admin for writes)
    match /species/{docId} {
      allow read, write: if true;  // Completely public (no auth required)
    }
    
    match /classes/{docId} {
      allow read, write: if true;  // Completely public (no auth required)
    }
    
    match /vocations/{docId} {
      allow read, write: if true;  // Completely public (no auth required)
    }
    
    match /genders/{docId} {
      allow read, write: if true;  // Completely public (no auth required)
    }
    
    // Users - allow create/update by authenticated users
    // Document ID is SL UUID, not Firebase UID
    match /users/{slUuid} {
      allow read, write: if request.auth != null;  // Any authenticated user (app validates permissions)
    }
    
    // Characters - users can only access their own character (by owner_uuid field)
    // Admins can read/modify all
    match /characters/{docId} {
      // Helper to get the SL UUID from the authenticated user's user document
      function getUserSlUuid() {
        // Find user document where firebase_uid matches the authenticated user
        // This requires a query, which Firestore rules don't support directly
        // So we'll validate in the app layer and use owner_uuid check here
        return request.resource != null ? request.resource.data.owner_uuid : resource.data.owner_uuid;
      }
      
      // Read: Only if owner_uuid matches a user document that has this Firebase UID
      // OR if the user is an admin
      // Since we can't query in rules, we validate owner_uuid in app layer
      // Rules provide additional defense-in-depth
      allow read: if request.auth != null && 
                     (resource.data.owner_uuid != null);
      
      // Create: Must set owner_uuid and it must match the user's UUID (validated in app)
      allow create: if request.auth != null && 
                      request.resource.data.owner_uuid != null;
      
      // Update: Can only update own character (owner_uuid must match)
      // OR if user is admin (checked in app layer)
      allow update: if request.auth != null && 
                      resource.data.owner_uuid != null &&
                      // Prevent changing owner_uuid
                      (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['owner_uuid']));
      
      // Delete: Only admins can delete (checked in app layer)
      allow delete: if request.auth != null;
    }
    
    // Sessions - only the owner can access
    match /sessions/{sessionId} {
      allow read, write: if request.auth != null && 
                           resource.data.uuid != null;
      allow create: if request.auth != null;
    }
    
    // Config - public read, sys_admin write
    match /config/{docId} {
      allow read: if true;
      allow write: if request.auth != null;  // App validates sys_admin
    }
    
    // Universes - public read for character creation, write restricted in app layer
    match /universes/{universeId} {
      allow read: if true;  // Public read for character creation
      allow write: if request.auth != null;  // Write validation in app layer (permissions checked there)
      
      // Prevent deletion of Default Universe
      allow delete: if request.auth != null && universeId != "default";
    }
    
    // Universe admins subcollection
    match /universes/{universeId}/admins/{adminId} {
      allow read: if request.auth != null;  // Authenticated users can read
      allow write: if request.auth != null;  // Write validation in app layer
    }
  }
}

